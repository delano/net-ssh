<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />

	<title>Module: Net::SSH::Transport::PacketStream</title>

	<link rel="stylesheet" href="../../../rdoc.css" type="text/css" media="screen" />

	<script src="../../../js/jquery.js" type="text/javascript"
		charset="utf-8"></script>
	<script src="../../../js/thickbox-compressed.js" type="text/javascript"
		charset="utf-8"></script>
	<script src="../../../js/quicksearch.js" type="text/javascript"
		charset="utf-8"></script>
	<script src="../../../js/darkfish.js" type="text/javascript"
		charset="utf-8"></script>

</head>
<body class="module">

	<div id="metadata">
		<div id="file-metadata">
			<div id="file-list-section" class="section">
				<h3 class="section-header">In Files</h3>
				<div class="section-body">
					<ul>
					
						<li><a href="../../../lib/net/ssh/transport/packet_stream_rb.html?TB_iframe=true&amp;height=550&amp;width=785"
							class="thickbox" title="lib/net/ssh/transport/packet_stream.rb">lib/net/ssh/transport/packet_stream.rb</a></li>
					
					</ul>
				</div>
			</div>

			
		</div>

		<div id="class-metadata">

			<!-- Parent Class -->
			

			<!-- Namespace Contents -->
			

			<!-- Method Quickref -->
			
			<div id="method-list-section" class="section">
				<h3 class="section-header">Methods</h3>
				<ul class="link-list">
					
					<li><a href="#M000362">::extended</a></li>
					
					<li><a href="#M000365">#available_for_read?</a></li>
					
					<li><a href="#M000369">#cleanup</a></li>
					
					<li><a href="#M000363">#client_name</a></li>
					
					<li><a href="#M000368">#enqueue_packet</a></li>
					
					<li><a href="#M000370">#if_needs_rekey?</a></li>
					
					<li><a href="#M000371">#initialize_ssh</a></li>
					
					<li><a href="#M000366">#next_packet</a></li>
					
					<li><a href="#M000364">#peer_ip</a></li>
					
					<li><a href="#M000374">#poll_next_packet</a></li>
					
					<li><a href="#M000367">#send_packet</a></li>
					
				</ul>
			</div>
			

			<!-- Included Modules -->
			
			<div id="includes-section" class="section">
				<h3 class="section-header">Included Modules</h3>
				<ul class="link-list">
				
				
					<li><a class="include" href="../../SSH.html">Net::SSH</a></li>
				
				
				</ul>
			</div>
			
		</div>

		<div id="project-metadata">
			
			
			<div id="fileindex-section" class="section project-section">
				<h3 class="section-header">Files</h3>
				<ul>
				
					<li class="file"><a href="../../../CHANGELOG_rdoc.html">CHANGELOG.rdoc</a></li>
				
					<li class="file"><a href="../../../README_rdoc.html">README.rdoc</a></li>
				
					<li class="file"><a href="../../../THANKS_rdoc.html">THANKS.rdoc</a></li>
				
				</ul>
			</div>
			

			<div id="classindex-section" class="section project-section">
				<h3 class="section-header">Class Index
					<span class="search-toggle"><img src="../../../images/find.png"
						height="16" width="16" alt="[+]"
						title="show/hide quicksearch" /></span></h3>
				<form action="#" method="get" accept-charset="utf-8" class="initially-hidden">
				<fieldset>
					<legend>Quicksearch</legend>
					<input type="text" name="quicksearch" value=""
						class="quicksearch-field" />
				</fieldset>
				</form>

				<ul class="link-list">
				
					<li><a href="../../../Net.html">Net</a></li>
				
					<li><a href="../../../Net/SSH.html">Net::SSH</a></li>
				
					<li><a href="../../../Net/SSH/Authentication.html">Net::SSH::Authentication</a></li>
				
					<li><a href="../../../Net/SSH/Authentication/Agent.html">Net::SSH::Authentication::Agent</a></li>
				
					<li><a href="../../../Net/SSH/Authentication/Agent/Comment.html">Net::SSH::Authentication::Agent::Comment</a></li>
				
					<li><a href="../../../Net/SSH/Authentication/AgentError.html">Net::SSH::Authentication::AgentError</a></li>
				
					<li><a href="../../../Net/SSH/Authentication/AgentNotAvailable.html">Net::SSH::Authentication::AgentNotAvailable</a></li>
				
					<li><a href="../../../Net/SSH/Authentication/Constants.html">Net::SSH::Authentication::Constants</a></li>
				
					<li><a href="../../../Net/SSH/Authentication/KeyManager.html">Net::SSH::Authentication::KeyManager</a></li>
				
					<li><a href="../../../Net/SSH/Authentication/KeyManagerError.html">Net::SSH::Authentication::KeyManagerError</a></li>
				
					<li><a href="../../../Net/SSH/Authentication/Methods.html">Net::SSH::Authentication::Methods</a></li>
				
					<li><a href="../../../Net/SSH/Authentication/Methods/Abstract.html">Net::SSH::Authentication::Methods::Abstract</a></li>
				
					<li><a href="../../../Net/SSH/Authentication/Methods/Hostbased.html">Net::SSH::Authentication::Methods::Hostbased</a></li>
				
					<li><a href="../../../Net/SSH/Authentication/Methods/KeyboardInteractive.html">Net::SSH::Authentication::Methods::KeyboardInteractive</a></li>
				
					<li><a href="../../../Net/SSH/Authentication/Methods/Password.html">Net::SSH::Authentication::Methods::Password</a></li>
				
					<li><a href="../../../Net/SSH/Authentication/Methods/Publickey.html">Net::SSH::Authentication::Methods::Publickey</a></li>
				
					<li><a href="../../../Net/SSH/Authentication/Pageant.html">Net::SSH::Authentication::Pageant</a></li>
				
					<li><a href="../../../Net/SSH/Authentication/Pageant/Socket.html">Net::SSH::Authentication::Pageant::Socket</a></li>
				
					<li><a href="../../../Net/SSH/Authentication/Pageant/Win.html">Net::SSH::Authentication::Pageant::Win</a></li>
				
					<li><a href="../../../Net/SSH/Authentication/Session.html">Net::SSH::Authentication::Session</a></li>
				
					<li><a href="../../../Net/SSH/AuthenticationFailed.html">Net::SSH::AuthenticationFailed</a></li>
				
					<li><a href="../../../Net/SSH/Buffer.html">Net::SSH::Buffer</a></li>
				
					<li><a href="../../../Net/SSH/BufferedIo.html">Net::SSH::BufferedIo</a></li>
				
					<li><a href="../../../Net/SSH/ChannelOpenFailed.html">Net::SSH::ChannelOpenFailed</a></li>
				
					<li><a href="../../../Net/SSH/ChannelRequestFailed.html">Net::SSH::ChannelRequestFailed</a></li>
				
					<li><a href="../../../Net/SSH/Config.html">Net::SSH::Config</a></li>
				
					<li><a href="../../../Net/SSH/Connection.html">Net::SSH::Connection</a></li>
				
					<li><a href="../../../Net/SSH/Connection/Channel.html">Net::SSH::Connection::Channel</a></li>
				
					<li><a href="../../../Net/SSH/Connection/Constants.html">Net::SSH::Connection::Constants</a></li>
				
					<li><a href="../../../Net/SSH/Connection/Session.html">Net::SSH::Connection::Session</a></li>
				
					<li><a href="../../../Net/SSH/Connection/Session/NilChannel.html">Net::SSH::Connection::Session::NilChannel</a></li>
				
					<li><a href="../../../Net/SSH/Connection/Term.html">Net::SSH::Connection::Term</a></li>
				
					<li><a href="../../../Net/SSH/Disconnect.html">Net::SSH::Disconnect</a></li>
				
					<li><a href="../../../Net/SSH/Exception.html">Net::SSH::Exception</a></li>
				
					<li><a href="../../../Net/SSH/HostKeyMismatch.html">Net::SSH::HostKeyMismatch</a></li>
				
					<li><a href="../../../Net/SSH/KeyFactory.html">Net::SSH::KeyFactory</a></li>
				
					<li><a href="../../../Net/SSH/KnownHosts.html">Net::SSH::KnownHosts</a></li>
				
					<li><a href="../../../Net/SSH/Loggable.html">Net::SSH::Loggable</a></li>
				
					<li><a href="../../../Net/SSH/Packet.html">Net::SSH::Packet</a></li>
				
					<li><a href="../../../Net/SSH/PromptMethods.html">Net::SSH::PromptMethods</a></li>
				
					<li><a href="../../../Net/SSH/PromptMethods/Clear.html">Net::SSH::PromptMethods::Clear</a></li>
				
					<li><a href="../../../Net/SSH/PromptMethods/Highline.html">Net::SSH::PromptMethods::Highline</a></li>
				
					<li><a href="../../../Net/SSH/PromptMethods/Termios.html">Net::SSH::PromptMethods::Termios</a></li>
				
					<li><a href="../../../Net/SSH/Proxy.html">Net::SSH::Proxy</a></li>
				
					<li><a href="../../../Net/SSH/Proxy/ConnectError.html">Net::SSH::Proxy::ConnectError</a></li>
				
					<li><a href="../../../Net/SSH/Proxy/Error.html">Net::SSH::Proxy::Error</a></li>
				
					<li><a href="../../../Net/SSH/Proxy/HTTP.html">Net::SSH::Proxy::HTTP</a></li>
				
					<li><a href="../../../Net/SSH/Proxy/SOCKS4.html">Net::SSH::Proxy::SOCKS4</a></li>
				
					<li><a href="../../../Net/SSH/Proxy/SOCKS5.html">Net::SSH::Proxy::SOCKS5</a></li>
				
					<li><a href="../../../Net/SSH/Proxy/UnauthorizedError.html">Net::SSH::Proxy::UnauthorizedError</a></li>
				
					<li><a href="../../../Net/SSH/Service.html">Net::SSH::Service</a></li>
				
					<li><a href="../../../Net/SSH/Service/Forward.html">Net::SSH::Service::Forward</a></li>
				
					<li><a href="../../../Net/SSH/Test.html">Net::SSH::Test</a></li>
				
					<li><a href="../../../Net/SSH/Test/Channel.html">Net::SSH::Test::Channel</a></li>
				
					<li><a href="../../../Net/SSH/Test/Extensions.html">Net::SSH::Test::Extensions</a></li>
				
					<li><a href="../../../Net/SSH/Test/Extensions/BufferedIo.html">Net::SSH::Test::Extensions::BufferedIo</a></li>
				
					<li><a href="../../../Net/SSH/Test/Extensions/Channel.html">Net::SSH::Test::Extensions::Channel</a></li>
				
					<li><a href="../../../Net/SSH/Test/Extensions/IO.html">Net::SSH::Test::Extensions::IO</a></li>
				
					<li><a href="../../../Net/SSH/Test/Extensions/IO/ClassMethods.html">Net::SSH::Test::Extensions::IO::ClassMethods</a></li>
				
					<li><a href="../../../Net/SSH/Test/Extensions/PacketStream.html">Net::SSH::Test::Extensions::PacketStream</a></li>
				
					<li><a href="../../../Net/SSH/Test/Kex.html">Net::SSH::Test::Kex</a></li>
				
					<li><a href="../../../Net/SSH/Test/LocalPacket.html">Net::SSH::Test::LocalPacket</a></li>
				
					<li><a href="../../../Net/SSH/Test/Packet.html">Net::SSH::Test::Packet</a></li>
				
					<li><a href="../../../Net/SSH/Test/RemotePacket.html">Net::SSH::Test::RemotePacket</a></li>
				
					<li><a href="../../../Net/SSH/Test/Script.html">Net::SSH::Test::Script</a></li>
				
					<li><a href="../../../Net/SSH/Test/Socket.html">Net::SSH::Test::Socket</a></li>
				
					<li><a href="../../../Net/SSH/Transport.html">Net::SSH::Transport</a></li>
				
					<li><a href="../../../Net/SSH/Transport/Algorithms.html">Net::SSH::Transport::Algorithms</a></li>
				
					<li><a href="../../../Net/SSH/Transport/CipherFactory.html">Net::SSH::Transport::CipherFactory</a></li>
				
					<li><a href="../../../Net/SSH/Transport/Constants.html">Net::SSH::Transport::Constants</a></li>
				
					<li><a href="../../../Net/SSH/Transport/HMAC.html">Net::SSH::Transport::HMAC</a></li>
				
					<li><a href="../../../Net/SSH/Transport/HMAC/Abstract.html">Net::SSH::Transport::HMAC::Abstract</a></li>
				
					<li><a href="../../../Net/SSH/Transport/HMAC/MD5.html">Net::SSH::Transport::HMAC::MD5</a></li>
				
					<li><a href="../../../Net/SSH/Transport/HMAC/MD5_96.html">Net::SSH::Transport::HMAC::MD5_96</a></li>
				
					<li><a href="../../../Net/SSH/Transport/HMAC/None.html">Net::SSH::Transport::HMAC::None</a></li>
				
					<li><a href="../../../Net/SSH/Transport/HMAC/SHA1.html">Net::SSH::Transport::HMAC::SHA1</a></li>
				
					<li><a href="../../../Net/SSH/Transport/HMAC/SHA1_96.html">Net::SSH::Transport::HMAC::SHA1_96</a></li>
				
					<li><a href="../../../Net/SSH/Transport/IdentityCipher.html">Net::SSH::Transport::IdentityCipher</a></li>
				
					<li><a href="../../../Net/SSH/Transport/Kex.html">Net::SSH::Transport::Kex</a></li>
				
					<li><a href="../../../Net/SSH/Transport/Kex/DiffieHellmanGroup1SHA1.html">Net::SSH::Transport::Kex::DiffieHellmanGroup1SHA1</a></li>
				
					<li><a href="../../../Net/SSH/Transport/Kex/DiffieHellmanGroupExchangeSHA1.html">Net::SSH::Transport::Kex::DiffieHellmanGroupExchangeSHA1</a></li>
				
					<li><a href="../../../Net/SSH/Transport/PacketStream.html">Net::SSH::Transport::PacketStream</a></li>
				
					<li><a href="../../../Net/SSH/Transport/ServerVersion.html">Net::SSH::Transport::ServerVersion</a></li>
				
					<li><a href="../../../Net/SSH/Transport/Session.html">Net::SSH::Transport::Session</a></li>
				
					<li><a href="../../../Net/SSH/Transport/State.html">Net::SSH::Transport::State</a></li>
				
					<li><a href="../../../Net/SSH/Verifiers.html">Net::SSH::Verifiers</a></li>
				
					<li><a href="../../../Net/SSH/Verifiers/Lenient.html">Net::SSH::Verifiers::Lenient</a></li>
				
					<li><a href="../../../Net/SSH/Verifiers/Null.html">Net::SSH::Verifiers::Null</a></li>
				
					<li><a href="../../../Net/SSH/Verifiers/Strict.html">Net::SSH::Verifiers::Strict</a></li>
				
					<li><a href="../../../Net/SSH/Version.html">Net::SSH::Version</a></li>
				
					<li><a href="../../../OpenSSL.html">OpenSSL</a></li>
				
					<li><a href="../../../OpenSSL/BN.html">OpenSSL::BN</a></li>
				
					<li><a href="../../../OpenSSL/PKey.html">OpenSSL::PKey</a></li>
				
					<li><a href="../../../OpenSSL/PKey/DH.html">OpenSSL::PKey::DH</a></li>
				
					<li><a href="../../../OpenSSL/PKey/DSA.html">OpenSSL::PKey::DSA</a></li>
				
					<li><a href="../../../OpenSSL/PKey/PKey.html">OpenSSL::PKey::PKey</a></li>
				
					<li><a href="../../../OpenSSL/PKey/RSA.html">OpenSSL::PKey::RSA</a></li>
				
					<li><a href="../../../String.html">String</a></li>
				
				</ul>
				<div id="no-class-search-results" style="display: none;">No matching classes.</div>
			</div>

			
		</div>
	</div>

	<div id="documentation">
		<h1 class="module">Net::SSH::Transport::PacketStream</h1>

		<div id="description">
			<p>
A module that builds additional functionality onto the <a
href="../BufferedIo.html">Net::SSH::BufferedIo</a> module. It adds <a
href="../../SSH.html">SSH</a> encryption, compression, and packet
validation, as per the SSH2 protocol. It also adds an abstraction for
polling packets, to allow for both blocking and non-blocking reads.
</p>

		</div>

		<!-- Constants -->
		

		<!-- Attributes -->
		
		<div id="attribute-method-details" class="method-section section">
			<h3 class="section-header">Attributes</h3>

			
			<div id="hints-attribute-method" class="method-detail">
				<a name="hints"></a>
				
				<div class="method-heading attribute-method-heading">
					<span class="method-name">hints</span><span
						class="attribute-access-type">[R]</span>
				</div>

				<div class="method-description">
				
				<p>
The map of &#8220;hints&#8221; that can be used to modify the behavior of
the packet stream. For instance, when authentication succeeds, an
&#8220;authenticated&#8221; hint is set, which is used to determine whether
or not to compress the data when using the &#8220;delayed&#8221;
compression algorithm.
</p>
				
				</div>
			</div>
			
			<div id="server-attribute-method" class="method-detail">
				<a name="server"></a>
				
				<div class="method-heading attribute-method-heading">
					<span class="method-name">server</span><span
						class="attribute-access-type">[R]</span>
				</div>

				<div class="method-description">
				
				<p>
The server state object, which encapsulates the algorithms used to
interpret packets coming from the server.
</p>
				
				</div>
			</div>
			
			<div id="client-attribute-method" class="method-detail">
				<a name="client"></a>
				
				<div class="method-heading attribute-method-heading">
					<span class="method-name">client</span><span
						class="attribute-access-type">[R]</span>
				</div>

				<div class="method-description">
				
				<p>
The client state object, which encapsulates the algorithms used to build
packets to send to the server.
</p>
				
				</div>
			</div>
			
		</div>
		

		<!-- Methods -->
		
		<div id="public-class-method-details" class="method-section section">
			<h3 class="section-header">Public Class Methods</h3>

		
			<div id="extended-method" class="method-detail ">
				<a name="M000362"></a>

				<div class="method-heading">
				
					<span class="method-name">extended</span><span
						class="method-args">(object)</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					<p class="missing-docs">(Not documented)</p>
					

					
					<div class="method-source-code"
						id="extended-source">
<pre>
    <span class="ruby-comment cmt"># File lib/net/ssh/transport/packet_stream.rb, line 17</span>
17:     <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">extended</span>(<span class="ruby-identifier">object</span>)
18:       <span class="ruby-identifier">object</span>.<span class="ruby-identifier">__send__</span>(<span class="ruby-identifier">:initialize_ssh</span>)
19:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				
			</div>

		
		</div>
	
		<div id="public-instance-method-details" class="method-section section">
			<h3 class="section-header">Public Instance Methods</h3>

		
			<div id="available-for-read--method" class="method-detail ">
				<a name="M000365"></a>

				<div class="method-heading">
				
					<span class="method-name">available_for_read?</span><span
						class="method-args">()</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					<p>
Returns true if the IO is available for reading, and false otherwise.
</p>
					

					
					<div class="method-source-code"
						id="available-for-read--source">
<pre>
    <span class="ruby-comment cmt"># File lib/net/ssh/transport/packet_stream.rb, line 67</span>
67:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">available_for_read?</span>
68:       <span class="ruby-identifier">result</span> = <span class="ruby-constant">IO</span>.<span class="ruby-identifier">select</span>([<span class="ruby-keyword kw">self</span>], <span class="ruby-keyword kw">nil</span>, <span class="ruby-keyword kw">nil</span>, <span class="ruby-value">0</span>)
69:       <span class="ruby-identifier">result</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">any?</span>
70:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				
			</div>

		
			<div id="cleanup-method" class="method-detail ">
				<a name="M000369"></a>

				<div class="method-heading">
				
					<span class="method-name">cleanup</span><span
						class="method-args">()</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					<p>
Performs any pending cleanup necessary on the IO and its associated state
objects. (See <a href="State.html#M000397">State#cleanup</a>).
</p>
					

					
					<div class="method-source-code"
						id="cleanup-source">
<pre>
     <span class="ruby-comment cmt"># File lib/net/ssh/transport/packet_stream.rb, line 150</span>
150:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">cleanup</span>
151:       <span class="ruby-identifier">client</span>.<span class="ruby-identifier">cleanup</span>
152:       <span class="ruby-identifier">server</span>.<span class="ruby-identifier">cleanup</span>
153:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				
			</div>

		
			<div id="client-name-method" class="method-detail ">
				<a name="M000363"></a>

				<div class="method-heading">
				
					<span class="method-name">client_name</span><span
						class="method-args">()</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					<p>
The name of the client (local) end of the socket, as reported by the
socket.
</p>
					

					
					<div class="method-source-code"
						id="client-name-source">
<pre>
    <span class="ruby-comment cmt"># File lib/net/ssh/transport/packet_stream.rb, line 37</span>
37:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">client_name</span>
38:       <span class="ruby-ivar">@client_name</span> <span class="ruby-operator">||=</span> <span class="ruby-keyword kw">begin</span>
39:         <span class="ruby-identifier">sockaddr</span> = <span class="ruby-identifier">getsockname</span>
40:         <span class="ruby-keyword kw">begin</span>
41:           <span class="ruby-constant">Socket</span>.<span class="ruby-identifier">getnameinfo</span>(<span class="ruby-identifier">sockaddr</span>, <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">NI_NAMEREQD</span>).<span class="ruby-identifier">first</span>
42:         <span class="ruby-keyword kw">rescue</span>
43:           <span class="ruby-keyword kw">begin</span>
44:             <span class="ruby-constant">Socket</span>.<span class="ruby-identifier">getnameinfo</span>(<span class="ruby-identifier">sockaddr</span>).<span class="ruby-identifier">first</span>
45:           <span class="ruby-keyword kw">rescue</span>
46:             <span class="ruby-keyword kw">begin</span>
47:               <span class="ruby-constant">Socket</span>.<span class="ruby-identifier">gethostbyname</span>(<span class="ruby-constant">Socket</span>.<span class="ruby-identifier">gethostname</span>).<span class="ruby-identifier">first</span>
48:             <span class="ruby-keyword kw">rescue</span>
49:               <span class="ruby-identifier">lwarn</span> { <span class="ruby-value str">&quot;the client ipaddr/name could not be determined&quot;</span> }
50:               <span class="ruby-value str">&quot;unknown&quot;</span>
51:             <span class="ruby-keyword kw">end</span>
52:           <span class="ruby-keyword kw">end</span>
53:         <span class="ruby-keyword kw">end</span>
54:       <span class="ruby-keyword kw">end</span>
55:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				
			</div>

		
			<div id="enqueue-packet-method" class="method-detail ">
				<a name="M000368"></a>

				<div class="method-heading">
				
					<span class="method-name">enqueue_packet</span><span
						class="method-args">(payload)</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					<p>
Enqueues a packet to be sent, but does not immediately send the packet. The
given payload is pre-processed according to the algorithms specified in the
client state (compression, cipher, and hmac).
</p>
					

					
					<div class="method-source-code"
						id="enqueue-packet-source">
<pre>
     <span class="ruby-comment cmt"># File lib/net/ssh/transport/packet_stream.rb, line 113</span>
113:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">enqueue_packet</span>(<span class="ruby-identifier">payload</span>)
114:       <span class="ruby-comment cmt"># try to compress the packet</span>
115:       <span class="ruby-identifier">payload</span> = <span class="ruby-identifier">client</span>.<span class="ruby-identifier">compress</span>(<span class="ruby-identifier">payload</span>)
116: 
117:       <span class="ruby-comment cmt"># the length of the packet, minus the padding</span>
118:       <span class="ruby-identifier">actual_length</span> = <span class="ruby-value">4</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">payload</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
119: 
120:       <span class="ruby-comment cmt"># compute the padding length</span>
121:       <span class="ruby-identifier">padding_length</span> = <span class="ruby-identifier">client</span>.<span class="ruby-identifier">cipher</span>.<span class="ruby-identifier">block_size</span> <span class="ruby-operator">-</span> (<span class="ruby-identifier">actual_length</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">client</span>.<span class="ruby-identifier">cipher</span>.<span class="ruby-identifier">block_size</span>)
122:       <span class="ruby-identifier">padding_length</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">client</span>.<span class="ruby-identifier">cipher</span>.<span class="ruby-identifier">block_size</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">padding_length</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">4</span>
123: 
124:       <span class="ruby-comment cmt"># compute the packet length (sans the length field itself)</span>
125:       <span class="ruby-identifier">packet_length</span> = <span class="ruby-identifier">payload</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">padding_length</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
126: 
127:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">packet_length</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">16</span>
128:         <span class="ruby-identifier">padding_length</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">client</span>.<span class="ruby-identifier">cipher</span>.<span class="ruby-identifier">block_size</span>
129:         <span class="ruby-identifier">packet_length</span> = <span class="ruby-identifier">payload</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">padding_length</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
130:       <span class="ruby-keyword kw">end</span>
131: 
132:       <span class="ruby-identifier">padding</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">padding_length</span>) { <span class="ruby-identifier">rand</span>(<span class="ruby-value">256</span>) }.<span class="ruby-identifier">pack</span>(<span class="ruby-value str">&quot;C*&quot;</span>)
133: 
134:       <span class="ruby-identifier">unencrypted_data</span> = [<span class="ruby-identifier">packet_length</span>, <span class="ruby-identifier">padding_length</span>, <span class="ruby-identifier">payload</span>, <span class="ruby-identifier">padding</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-value str">&quot;NCA*A*&quot;</span>)
135:       <span class="ruby-identifier">mac</span> = <span class="ruby-identifier">client</span>.<span class="ruby-identifier">hmac</span>.<span class="ruby-identifier">digest</span>([<span class="ruby-identifier">client</span>.<span class="ruby-identifier">sequence_number</span>, <span class="ruby-identifier">unencrypted_data</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-value str">&quot;NA*&quot;</span>))
136: 
137:       <span class="ruby-identifier">encrypted_data</span> = <span class="ruby-identifier">client</span>.<span class="ruby-identifier">update_cipher</span>(<span class="ruby-identifier">unencrypted_data</span>) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">client</span>.<span class="ruby-identifier">final_cipher</span>
138:       <span class="ruby-identifier">message</span> = <span class="ruby-identifier">encrypted_data</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">mac</span>
139: 
140:       <span class="ruby-identifier">debug</span> { <span class="ruby-node">&quot;queueing packet nr #{client.sequence_number} type #{payload.getbyte(0)} len #{packet_length}&quot;</span> }
141:       <span class="ruby-identifier">enqueue</span>(<span class="ruby-identifier">message</span>)
142: 
143:       <span class="ruby-identifier">client</span>.<span class="ruby-identifier">increment</span>(<span class="ruby-identifier">packet_length</span>)
144: 
145:       <span class="ruby-keyword kw">self</span>
146:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				
			</div>

		
			<div id="if-needs-rekey--method" class="method-detail ">
				<a name="M000370"></a>

				<div class="method-heading">
				
					<span class="method-name">if_needs_rekey?</span><span
						class="method-args">()</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					<p>
If the IO object requires a rekey operation (as indicated by either its
client or server state objects, see <a
href="State.html#M000403">State#needs_rekey?</a>), this will yield.
Otherwise, this does nothing.
</p>
					

					
					<div class="method-source-code"
						id="if-needs-rekey--source">
<pre>
     <span class="ruby-comment cmt"># File lib/net/ssh/transport/packet_stream.rb, line 158</span>
158:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">if_needs_rekey?</span>
159:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">client</span>.<span class="ruby-identifier">needs_rekey?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">needs_rekey?</span>
160:         <span class="ruby-keyword kw">yield</span>
161:         <span class="ruby-identifier">client</span>.<span class="ruby-identifier">reset!</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">client</span>.<span class="ruby-identifier">needs_rekey?</span>
162:         <span class="ruby-identifier">server</span>.<span class="ruby-identifier">reset!</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">needs_rekey?</span>
163:       <span class="ruby-keyword kw">end</span>
164:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				
			</div>

		
			<div id="next-packet-method" class="method-detail ">
				<a name="M000366"></a>

				<div class="method-heading">
				
					<span class="method-name">next_packet</span><span
						class="method-args">(mode=:nonblock)</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					<p>
Returns the next full packet. If the mode parameter is :nonblock (the
default), then this will return immediately, whether a packet is available
or not, and will return nil if there is no packet ready to be returned. If
the mode parameter is :block, then this method will block until a packet is
available.
</p>
					

					
					<div class="method-source-code"
						id="next-packet-source">
<pre>
     <span class="ruby-comment cmt"># File lib/net/ssh/transport/packet_stream.rb, line 77</span>
 77:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">next_packet</span>(<span class="ruby-identifier">mode</span>=<span class="ruby-identifier">:nonblock</span>)
 78:       <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">mode</span>
 79:       <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:nonblock</span> <span class="ruby-keyword kw">then</span>
 80:         <span class="ruby-identifier">fill</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">available_for_read?</span>
 81:         <span class="ruby-identifier">poll_next_packet</span>
 82: 
 83:       <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:block</span> <span class="ruby-keyword kw">then</span>
 84:         <span class="ruby-identifier">loop</span> <span class="ruby-keyword kw">do</span>
 85:           <span class="ruby-identifier">packet</span> = <span class="ruby-identifier">poll_next_packet</span>
 86:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">packet</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">packet</span>
 87: 
 88:           <span class="ruby-identifier">loop</span> <span class="ruby-keyword kw">do</span>
 89:             <span class="ruby-identifier">result</span> = <span class="ruby-constant">IO</span>.<span class="ruby-identifier">select</span>([<span class="ruby-keyword kw">self</span>]) <span class="ruby-keyword kw">or</span> <span class="ruby-keyword kw">next</span>
 90:             <span class="ruby-keyword kw">break</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">any?</span>
 91:           <span class="ruby-keyword kw">end</span>
 92: 
 93:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">fill</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">0</span>
 94:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">SSH</span><span class="ruby-operator">::</span><span class="ruby-constant">Disconnect</span>, <span class="ruby-value str">&quot;connection closed by remote host&quot;</span>
 95:           <span class="ruby-keyword kw">end</span>
 96:         <span class="ruby-keyword kw">end</span>
 97: 
 98:       <span class="ruby-keyword kw">else</span>
 99:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-node">&quot;expected :block or :nonblock, got #{mode.inspect}&quot;</span>
100:       <span class="ruby-keyword kw">end</span>
101:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				
			</div>

		
			<div id="peer-ip-method" class="method-detail ">
				<a name="M000364"></a>

				<div class="method-heading">
				
					<span class="method-name">peer_ip</span><span
						class="method-args">()</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					<p>
The IP address of the peer (remote) end of the socket, as reported by the
socket.
</p>
					

					
					<div class="method-source-code"
						id="peer-ip-source">
<pre>
    <span class="ruby-comment cmt"># File lib/net/ssh/transport/packet_stream.rb, line 59</span>
59:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">peer_ip</span>
60:       <span class="ruby-ivar">@peer_ip</span> <span class="ruby-operator">||=</span> <span class="ruby-keyword kw">begin</span>
61:         <span class="ruby-identifier">addr</span> = <span class="ruby-identifier">getpeername</span>
62:         <span class="ruby-constant">Socket</span>.<span class="ruby-identifier">getnameinfo</span>(<span class="ruby-identifier">addr</span>, <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">NI_NUMERICHOST</span> <span class="ruby-operator">|</span> <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">NI_NUMERICSERV</span>).<span class="ruby-identifier">first</span>
63:       <span class="ruby-keyword kw">end</span>
64:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				
			</div>

		
			<div id="send-packet-method" class="method-detail ">
				<a name="M000367"></a>

				<div class="method-heading">
				
					<span class="method-name">send_packet</span><span
						class="method-args">(payload)</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					<p>
Enqueues a packet to be sent, and blocks until the entire packet is sent.
</p>
					

					
					<div class="method-source-code"
						id="send-packet-source">
<pre>
     <span class="ruby-comment cmt"># File lib/net/ssh/transport/packet_stream.rb, line 105</span>
105:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">send_packet</span>(<span class="ruby-identifier">payload</span>)
106:       <span class="ruby-identifier">enqueue_packet</span>(<span class="ruby-identifier">payload</span>)
107:       <span class="ruby-identifier">wait_for_pending_sends</span>
108:     <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				
			</div>

		
		</div>
	
		<div id="protected-instance-method-details" class="method-section section">
			<h3 class="section-header">Protected Instance Methods</h3>

		
			<div id="initialize-ssh-method" class="method-detail ">
				<a name="M000371"></a>

				<div class="method-heading">
				
					<span class="method-name">initialize_ssh</span><span
						class="method-args">()</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					<p>
Called when this module is used to extend an object. It initializes the
states and generally prepares the object for use as a packet stream.
</p>
					

					
					<div class="method-source-code"
						id="initialize-ssh-source">
<pre>
     <span class="ruby-comment cmt"># File lib/net/ssh/transport/packet_stream.rb, line 170</span>
170:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize_ssh</span>
171:         <span class="ruby-ivar">@hints</span>  = {}
172:         <span class="ruby-ivar">@server</span> = <span class="ruby-constant">State</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword kw">self</span>, <span class="ruby-identifier">:server</span>)
173:         <span class="ruby-ivar">@client</span> = <span class="ruby-constant">State</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword kw">self</span>, <span class="ruby-identifier">:client</span>)
174:         <span class="ruby-ivar">@packet</span> = <span class="ruby-keyword kw">nil</span>
175:         <span class="ruby-identifier">initialize_buffered_io</span>
176:       <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				
			</div>

		
			<div id="poll-next-packet-method" class="method-detail ">
				<a name="M000374"></a>

				<div class="method-heading">
				
					<span class="method-name">poll_next_packet</span><span
						class="method-args">()</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					<p>
Tries to read the next packet. If there is insufficient data to read an
entire packet, this returns immediately, otherwise the packet is read,
post-processed according to the cipher, hmac, and compression algorithms
specified in the server state object, and returned as a new <a
href="../Packet.html">Packet</a> object.
</p>
					

					
					<div class="method-source-code"
						id="poll-next-packet-source">
<pre>
     <span class="ruby-comment cmt"># File lib/net/ssh/transport/packet_stream.rb, line 183</span>
183:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">poll_next_packet</span>
184:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@packet</span>.<span class="ruby-identifier">nil?</span>
185:           <span class="ruby-identifier">minimum</span> = <span class="ruby-identifier">server</span>.<span class="ruby-identifier">cipher</span>.<span class="ruby-identifier">block_size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">4</span> <span class="ruby-operator">?</span> <span class="ruby-value">4</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">cipher</span>.<span class="ruby-identifier">block_size</span>
186:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">available</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">minimum</span>
187:           <span class="ruby-identifier">data</span> = <span class="ruby-identifier">read_available</span>(<span class="ruby-identifier">minimum</span>)
188: 
189:           <span class="ruby-comment cmt"># decipher it</span>
190:           <span class="ruby-ivar">@packet</span> = <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">SSH</span><span class="ruby-operator">::</span><span class="ruby-constant">Buffer</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">server</span>.<span class="ruby-identifier">update_cipher</span>(<span class="ruby-identifier">data</span>))
191:           <span class="ruby-ivar">@packet_length</span> = <span class="ruby-ivar">@packet</span>.<span class="ruby-identifier">read_long</span>
192:         <span class="ruby-keyword kw">end</span>
193: 
194:         <span class="ruby-identifier">need</span> = <span class="ruby-ivar">@packet_length</span> <span class="ruby-operator">+</span> <span class="ruby-value">4</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">cipher</span>.<span class="ruby-identifier">block_size</span>
195:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">SSH</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>, <span class="ruby-node">&quot;padding error, need #{need} block #{server.cipher.block_size}&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">need</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">cipher</span>.<span class="ruby-identifier">block_size</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
196: 
197:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">available</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">need</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">hmac</span>.<span class="ruby-identifier">mac_length</span>
198: 
199:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">need</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
200:           <span class="ruby-comment cmt"># read the remainder of the packet and decrypt it.</span>
201:           <span class="ruby-identifier">data</span> = <span class="ruby-identifier">read_available</span>(<span class="ruby-identifier">need</span>)
202:           <span class="ruby-ivar">@packet</span>.<span class="ruby-identifier">append</span>(<span class="ruby-identifier">server</span>.<span class="ruby-identifier">update_cipher</span>(<span class="ruby-identifier">data</span>))
203:         <span class="ruby-keyword kw">end</span>
204: 
205:         <span class="ruby-comment cmt"># get the hmac from the tail of the packet (if one exists), and</span>
206:         <span class="ruby-comment cmt"># then validate it.</span>
207:         <span class="ruby-identifier">real_hmac</span> = <span class="ruby-identifier">read_available</span>(<span class="ruby-identifier">server</span>.<span class="ruby-identifier">hmac</span>.<span class="ruby-identifier">mac_length</span>) <span class="ruby-operator">||</span> <span class="ruby-value str">&quot;&quot;</span>
208: 
209:         <span class="ruby-ivar">@packet</span>.<span class="ruby-identifier">append</span>(<span class="ruby-identifier">server</span>.<span class="ruby-identifier">final_cipher</span>)
210:         <span class="ruby-identifier">padding_length</span> = <span class="ruby-ivar">@packet</span>.<span class="ruby-identifier">read_byte</span>
211: 
212:         <span class="ruby-identifier">payload</span> = <span class="ruby-ivar">@packet</span>.<span class="ruby-identifier">read</span>(<span class="ruby-ivar">@packet_length</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">padding_length</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>)
213:         <span class="ruby-identifier">padding</span> = <span class="ruby-ivar">@packet</span>.<span class="ruby-identifier">read</span>(<span class="ruby-identifier">padding_length</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">padding_length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
214: 
215:         <span class="ruby-identifier">my_computed_hmac</span> = <span class="ruby-identifier">server</span>.<span class="ruby-identifier">hmac</span>.<span class="ruby-identifier">digest</span>([<span class="ruby-identifier">server</span>.<span class="ruby-identifier">sequence_number</span>, <span class="ruby-ivar">@packet</span>.<span class="ruby-identifier">content</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-value str">&quot;NA*&quot;</span>))
216:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">SSH</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>, <span class="ruby-value str">&quot;corrupted mac detected&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">real_hmac</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">my_computed_hmac</span>
217: 
218:         <span class="ruby-comment cmt"># try to decompress the payload, in case compression is active</span>
219:         <span class="ruby-identifier">payload</span> = <span class="ruby-identifier">server</span>.<span class="ruby-identifier">decompress</span>(<span class="ruby-identifier">payload</span>)
220: 
221:         <span class="ruby-identifier">debug</span> { <span class="ruby-node">&quot;received packet nr #{server.sequence_number} type #{payload.getbyte(0)} len #{@packet_length}&quot;</span> }
222: 
223:         <span class="ruby-identifier">server</span>.<span class="ruby-identifier">increment</span>(<span class="ruby-ivar">@packet_length</span>)
224:         <span class="ruby-ivar">@packet</span> = <span class="ruby-keyword kw">nil</span>
225: 
226:         <span class="ruby-keyword kw">return</span> <span class="ruby-constant">Packet</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">payload</span>)
227:       <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				
			</div>

		
		</div>
	

	</div>


	<div id="rdoc-debugging-section-dump" class="debugging-section">
	
		<p>Disabled; run with --debug to generate this.</p>
	
	</div>

	<div id="validator-badges">
		<p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
		<p><small>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish
			Rdoc Generator</a> 1.1.6</small>.</p>
	</div>

</body>
</html>

